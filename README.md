# ZK笔记导航器 (ZK Navigator)

一个为 Obsidian 设计的ZK笔记导航插件，基于引用关系构建树形结构，提供可视化的笔记管理和快速操作功能。

## 核心功能

### 1. 基于反向链接的树形结构

- **引用关系**：通过文件中的 `[[link]]` 语法建立父子关系，引用当前文件的文件作为子条目（反向链接）
- **根文件指定**：在设置中指定根文件，从该文件开始构建树
- **交替编码**：每降低一个层级，用英文数字交替的方式编码
  - 根节点：`1`
  - 第一层：`1a`, `1b`, `1c` (字母)
  - 第二层：`1a1`, `1a2`, `1a3` (数字)
  - 第三层：`1a1a`, `1a1b`, `1a1c` (字母)
- **互相引用**：如果两个文件互相引用，则用小数点隔开，英文数字不交替
  - 例如：`1a1.1`, `1b.b` (互相引用时使用小数点)
- **动态更新**：当文件内容改变时，树结构自动更新

### 2. 可视化导航

- **树形展示**：按层级缩进显示笔记结构（每层 10px）
- **折叠/展开**：有子节点的条目可折叠子节点（使用 SVG 三角图标）
- **高亮显示**：
  - 当前打开文件：红色边框
  - 最近打开的 5 个文件：蓝色边框
- **笔记计数**：顶部显示笔记总数

### 3. 快捷操作

提供悬浮按钮（鼠标移到条目上显示）：

- **+ 添加子笔记**：创建当前笔记的子笔记（自动添加引用）
- **✎ 重命名**：修改笔记文件名

### 4. 状态持久化

- **折叠状态保存**：关闭 Obsidian 后重新打开，折叠状态保持不变
- **自动刷新**：文件创建、删除、重命名、打开时自动更新视图

## 编码规则详解

### 层级计算规则

1. **字母 ↔ 数字转换**：连续的英文字母或数字，算一个层级
2. **小数点**：不增加一个层级
3. **示例**：
   - `a` → level 1
   - `a1` → level 2
   - `a1a` → level 3
   - `a1.1` → level 3
   - `a1.1a` → level 4

### 排序规则

在同一层级中：

- **小数点优先**：`a1.1` < `a1.2` < `a1a` < `a1b`
- **数字递增**：`a1` < `a2` < `a3`
- **字母递增**：`a` < `b` < `c`

## 技术实现

### 文件结构

```
ob-zk/
├── main.ts           # 插件入口，设置管理
├── view.ts           # 主视图实现，UI 渲染和交互
├── utils.ts          # 工具函数（保留兼容性）
├── styles.css        # 样式定义
├── manifest.json     # 插件元数据
├── package.json      # 依赖管理
├── tsconfig.json     # TypeScript 配置
└── esbuild.config.mjs # 构建配置
```

### 核心类和方法

#### ZettelkastenView 类

```typescript
class ZettelkastenView extends ItemView {
  // 状态管理
  recentFiles: string[] // 最近打开的 5 个文件
  collapsedIds: Set<string> // 折叠的条目 ID

  // 核心方法
  refresh() // 刷新视图
  renderZettelList() // 渲染笔记列表
  getAllZettels() // 获取所有笔记并构建树结构
  createChildNote(parent) // 创建子笔记
  saveCollapsedState() // 保存折叠状态
}
```

### 引用关系构建

- 使用 `app.metadataCache.resolvedLinks` 获取所有文件的链接关系
- 手动计算反向链接：遍历所有文件，找出引用当前文件的文件
- 构建反向引用映射：`Record<string, number>` (sourcePath -> linkCount)
- 从根文件开始递归构建树，子条目是引用当前文件的文件（反向链接）
- 实现交替的字母/数字编码
- 检测互相引用并使用小数点分隔
- 自动编号：生成如 1, 1a, 1a1, 1a1a, 1.1 等格式的ID
